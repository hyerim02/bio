---
title: "CH3"
date: "2023-07-18"
output:
  pdf_document:
    latex_engine: xelatex
mainfont: NanumGothic
---
# 1. tidyverse  

```{r,message = FALSE}
library(tidyverse)
dat <- read.csv("C:\\Users\\phl02\\Desktop\\P\\bio\\ch3\\Ch3_chb.csv")
```  
```{r}
dat1<-dat
class(dat1) 
```   
```{r}
dim(dat1) 
```  
```{r}
colnames(dat1)
```   

\newpage  
# 2. Select 
## 원하는 변수 선택 
R에서 기본으로 사용하는 슬라이싱 코드와 비교

```{r}
dat1 %>% 
  select(id, b_alt, b_bil, b_alb)
```   
\newpage  
```{r}
dat1[ , c('id','b_alt','b_bil','b_alb')]
```  

\newpage  
숫자를 사용해서도 가능
```{r}
dat1 %>% 
  select(1, 8, 9, 13)
```    
\newpage  
다양하게도 선택 가능
```{r}  
dat1 %>% 
  select(1:4, 7:9, 13)
```
\newpage  
콜론도 가능
```{r}  
dat1 %>% 
  select(m6_alt:m6_plt)
```
\newpage  
## 특정 변수 제외하기  

```{r}  
dat1 %>% 
  select(-id, -index_date) %>% 
  colnames()
```
 
변수 이름 삭제 확인
```{r}  
colnames(dat1)
```
 
순서를 사용해도 가능
```{r}  
dat1 %>% 
  select(-1, -2) %>%     
  colnames()
```

특정 변수를 조합해서 제외
```{r}  
dat1 %>% 
  select(-(1:4), -(10:13)) %>%  
  ncol()
```
\newpage  
## 같은 특성을 가진 변수만 선택  

```{r}  
dat1 %>% 
  select(b_alt, m6_alt, m12_alt)
```
\newpage  
포함된 단어가 있으면 이 방법이 더 유용
```{r}  
dat1 %>% 
  select(contains('alt'))
```
\newpage
6개월째 측정한 변수만 선택
```{r}  
dat1 %>% 
  select(contains('m6'))
```
\newpage  
m6으로 시작하는 변수만 select 하는 방법도 있음
```{r}  
dat1 %>% 
  select(starts_with('m6'))
```
\newpage  
cr로 끝나는 변수
```{r}  
dat1 %>% 
  select(ends_with('cr'))
```
\newpage  
## 변수 이름 변경  
변경한 변수만 보임  

```{r}  
dat1 %>% 
  select(sex = gender)
```
\newpage  
이름 변경 후 다른 변수들은 그대로 유지하고 싶을 때
```{r}  
dat1 %>% 
  rename(sex = gender)
```
\newpage  
여러 개도 가능
```{r}  
dat1 %>% 
  rename(emr_id = id, baseline_date = index_date, sex = gender) %>% 
  colnames()
```
\newpage  
## 변수의 순서 변경 

```{r}  
dat1 %>% 
  select(treat_gr, hcc, id, everything()) %>%   
  colnames()
```
\newpage  
## 동시에 기능 사용하기  
어떤 코드가 더 가독성이 좋은지 생각해보기  
3가지 방법의 결과는 같음
```{r}  
dat1 %>% 
  select(id, gender, contains('m12')) %>%
  rename(sex = gender) %>%
  select(sex, everything())
```
\newpage  
```{r}  
dat1 %>% 
  select(sex = gender, id, contains('m12'))
```
\newpage  
```{r}  
dat1 %>% 
  select(sex = gender,
         id,
         contains('m12'))
```
\newpage  
## 흔히 범하는 오류 
4번째에서 7번째까지 변수 제외를 원함
```{r,warning=FALSE}  
dat1 %>% 
  select(-4:7) %>% 
  colnames()
```  
첫 번째에서 7번째까지 선택됨
아래와 같이 코드를 짜야 원하는 결과를 얻음
```{r}  
dat1 %>% 
  select(-c(4:7)) %>%   
  colnames()
```  
\newpage  
# 3. Filter
## 특정 조건을 만족하는 환자(row) 선택하기

```{r}
dat1 %>% 
  filter(id<=20)
``` 
\newpage 
select기능도 같이 사용해보기  

```{r}
dat1 %>% 
  filter(id<=20) %>% 
  select(id, starts_with('b_'))
```   
\newpage  
남자 환자만 선택  

```{r}
dat1 %>% 
  filter(gender =='M')
```   
\newpage 
## 복합조건 사용하기  
50세 이상의 남자 환자 선택  

```{r}
dat1 %>% 
  filter(age>=50, gender=='M')
```   
\newpage 
30세 이상 60세 이하  

```{r}
dat1 %>% 
  filter(age >=30 & age<=60)
```   
\newpage 
between 사용  

```{r}
dat1 %>% 
  filter(between (age, 30, 60)) 
```   
\newpage 
50세 이상이거나 간경변증이 있는 환자  

```{r}
dat1 %>% 
  filter(age >=50 | lc==1)
```   
\newpage 
and와 or을 같이 사용  

```{r}
dat1 %>% 
  filter( (age>=60 & gender=="M") | (age<=50 & gender=="F"))
```   
\newpage  
## 조건을 만족하지 않는 경우 골라내기  
여자 환자만  

```{r}
dat1 %>% 
  filter(gender!="M")
```   
\newpage 
간경변증이 없는 50세 이상의 환자  

```{r}
dat1 %>% 
  filter(lc !=1 & age >=50)
```   
\newpage 
## count기능  
성별에 따라 몇 명?  

```{r}
dat1 %>% 
  count(gender)
```   
남성이면서 간암이 있는 환자는?  

```{r}
dat1 %>% 
  filter(gender == 'M' & hcc ==1) %>% 
  count()
```   
남성이면서 간경변증이 있는 환자 중 hcc가 발생한 환자는?   

```{r}
dat1 %>% 
  filter(gender == 'M' & lc ==1) %>% 
  count(hcc) 
```   
남성이면서 간경변증이 있는 환자 중 hcc가 발생한 환자는
항바이러스 종류에 따라 몇 명?  

```{r}
dat1 %>% 
  filter(gender == 'M' & lc ==1) %>% 
  count(treat_gr, hcc)
```   

\newpage 
## 결측값 다루기  
결측값  

```{r}
dat1 %>% 
  filter(is.na(b_inr)) %>%  
  count()
```   
결측값이 없는 경우  

```{r}
dat1 %>% 
  filter(!is.na(b_inr))
```   
\newpage  
여러 변수에서 동시에 확인  

```{r}
dat1 %>% 
  filter(!is.na(b_inr),
         !is.na(b_alt),
         !is.na(b_plt)) %>% 
  count()
```  
\newpage  
##  결측값이 존재하지 않는 케이스만 남기기
특정 변수에서 결측값이 없는 환자  

```{r}
dat1 %>% 
  drop_na(b_inr, b_alt, b_plt) %>% 
  count()
```  
모든 변수에서 결측값이 없는 환자  

```{r}
dat1 %>% 
  drop_na() %>% 
  count()
```  
모든 변수에서 결측값이 없는 환자  

```{r}
na.count <- apply(dat1, 2, function(x)sum(is.na(x)))
na.count
```  
\newpage 
# 4. Mutate
## 기존 변수를 이용해서 새로운 변수 만들기  

```{r}
dat1 %>% 
  mutate(alt_plt = b_alt / b_plt) %>% 
  select(b_alt, b_plt, alt_plt)
```   
결측값이 있는 경우 새로운 변수 값이 어떻게 나오는지 확인  

```{r}
dat1 %>% 
  mutate(alt_plt = b_alt /b_plt) %>% 
  select(id, b_alt, b_plt, alt_plt) %>% 
  filter(is.na(b_alt) | is.na(b_plt))
```   
\newpage
결측값이 있으면 계산이 불가능하므로 결측값이 있는 경우 제거  

```{r}
dat1 %>% 
  drop_na(b_alt, b_plt) %>% 
  mutate(alt_plt = b_alt /b_plt) %>% 
  select(id, b_alt, b_plt, alt_plt) 
```   
\newpage
## 조건을 이용해서 새로운 변수 만들기  


```{r}
dat1 %>% 
  mutate(age_gr=ifelse(age >=50,'above_50','below_50')) %>%
  select(id, age, age_gr)
```   
```{r}
dat1 %>% 
  mutate(age_gr=ifelse(age >=50,'above_50','below_50'))%>%
  count(age_gr)
```   
\newpage

```{r}
dat1 %>% 
  mutate(bil_gr=ifelse(b_bil<2,'A',ifelse(b_bil<3,'B','C'))) %>%  
  select(id, b_bil, bil_gr)
```   
```{r}
dat1 %>% 
  mutate(bil_gr=ifelse(b_bil<2,'A',
                       ifelse(b_bil<3,'B','C'))) %>%  
  count(bil_gr)
```
\newpage

```{r}
dat1 %>% 
  mutate(risk_gr=ifelse(age>=50 & lc==1,'high_risk',
                        ifelse(age<50 & lc==0, 
                        'low_risk','intermediate_risk')))
```  
```{r}
dat1 %>% 
  mutate(risk_gr=ifelse(age>=50 & lc==1,'high_risk',
                        ifelse(age<50 & lc==0, 
                        'low_risk','intermediate_risk'))) %>% 
  count(risk_gr)
```  
\newpage
## 새로운 변수 만들고 나머지 변수 제거  

```{r}
dat1 %>% 
  transmute(risk_gr=ifelse(age>=50 & lc==1,'high_risk',
                           ifelse(age<50 & lc==0, 'low_risk', 'intermediate_risk')))
```
\newpage
## 변수값의 순서를 새로운 변수로 만들기

```{r}
dat1 %>% 
  mutate(age_rank = min_rank(age)) %>% 
  select(id, age, age_rank)
```  
\newpage
내림차순  

```{r}
dat1 %>% 
  mutate(age_rank = min_rank(desc(age))) %>% 
  select(id, age, age_rank)
```
\newpage
## 순서를 정할 때 중간에 gap없이 새로운 변수 만들기  
min_rank와 차이는 1등이 2명인 경우 3등이 아니라 2등으로 나옴  

```{r}
dat1 %>% 
  mutate(age_rank = dense_rank(age)) %>% 
  select(id, age, age_rank)
```  
\newpage
## 퍼센트 순위로 새로운 변수 만들기   

```{r}
dat1 %>% 
  mutate(age_rank = percent_rank(age)) %>% 
  select(id, age, age_rank) %>% 
  arrange(age_rank)
```  
\newpage
## 누적합계를 변수로 만들기  

```{r}
dat1 %>% 
  mutate(id_sum = cumsum(id)) %>% 
  select(id, id_sum)
```  
\newpage
## 동시에 여러 개의 새로운 변수 만들기  

```{r}
dat1 %>% 
  mutate(age_gr=ifelse(age>=50,'above 50','below 50')) %>% 
  mutate(bil_gr=ifelse(b_bil<2,'A',
                       ifelse(b_bil>3,'C','B'))) %>% 
  select(age, age_gr, b_bil, bil_gr)
```  
\newpage
## 연속형 변수를 일정 범위마다 그룹화하기  

```{r}
dat1 %>% 
  mutate(age_gr=ifelse(age>=60,'>=60',
                       ifelse(age>=50,'>=50',
                              ifelse(age>=40,'>=40',
                                     ifelse(age>=30,'>=30','<30'))))) %>% 
  select(age, age_gr)
```
\newpage
간단하게 
```{r}
dat1 %>% 
  mutate(age_gr=cut(age,
                    c(-Inf,30,40,50,60,Inf),
                    c('<30','>=30','>=40','>=50','>=60'))) %>%    
  select(age, age_gr)
```  
\newpage
10세 차이를 기준으로 분류하기  

```{r}
dat1 %>% 
  mutate(age_gr=cut_width(age, width=10)) %>% 
  select(age, age_gr)
```  
\newpage
구간 범위에 옵션주기  

```{r}
dat1 %>% 
  mutate(age_gr=cut_width(age, width=10, boundary=0)) %>%
  mutate(age_gr2=cut_width(age, width=10, boundary=9)) %>% 
  select(age, age_gr, age_gr2)
```  
\newpage
## 연속형 변수를 균일한 범위를 가지는 그룹으로 나누기  

```{r}
dat1 %>% 
  mutate(age_gr=cut_interval(age, n=4)) %>% 
  select(age, age_gr) %>% 
  count(age_gr)
```
\newpage
## 연속형 변수를 원하는 개수의 그룹으로 나누기
```{r}
dat1 %>% 
  mutate(age_gr = cut_number(age, n=5)) %>% 
  select(age, age_gr)
```
```{r}
dat1 %>% 
  mutate(age_gr = cut_number(age, n=5)) %>% 
  select(age, age_gr) %>% 
  count(age_gr)
```  
\newpage
# 5. Arrange
## 오름차순

```{r}
dat1 %>% 
  arrange(age)
```
\newpage
내림차순  

```{r}
dat1 %>% 
  arrange(desc(age))
```
\newpage
## 여러 개 변수를 오름차순  

```{r}
dat1 %>% 
  arrange(age, b_alt) %>% 
  select(age, b_alt)
```   
\newpage
# 6. Summarise
## 원하는 변수의 평균 구하기  

```{r}
dat1 %>% 
  summarise(mean_age = mean(age))
```  
## 여러 개의 요약정보 동시에 구하기  

```{r}
dat1 %>% 
  summarise(mean_age = mean(age),
            median_age = median(age),
            iqr_age = IQR(age))
```  
## 고유값 개수 확인  

```{r}
dat1 %>% 
  summarise(n_distinct(age))
```
```{r}  
unique(dat1$age)
```
```{r}  
length(unique(dat1$age))
```
## 발생률 구하기   

```{r}  
dat1 %>% 
  summarise( patient_number = n(),
             event = sum(hcc),
             person_year = sum(hcc_yr),
             incidence_rate = event / person_year)
```
\newpage
# 7. Group_by
## 원하는 변수로 나누어 각각 값 계산  

```{r}  
dat1 %>% 
  group_by(gender) %>% 
  summarise(mean_age = mean(age))
```  
## 해당 조건을 만족하는 환자의 숫자를 변수로 만들기

```{r}  
dat1 %>% 
  group_by(gender, lc) %>% 
  summarise(patient_no = n(),
            mean_age = mean(age))
```
```{r}  
dat1 %>% 
  group_by(gender, lc) %>% 
  summarise(patient_no = n(),
            mean_inr = mean(b_inr))
```
```{r}  
dat1 %>% 
  group_by(gender, lc) %>% 
  summarise(patient_no = n(),
            mean_inr = mean(b_inr, na.rm=T))
```  
## summary table 만들기  

```{r}  
dat1 %>% 
  group_by(gender, lc) %>% 
  summarise( N_alt = sum(!is.na(b_alt)),
             MEAN_alt = mean(b_alt, na.rm=T),
             MEDIAN_alt = median(b_alt, na.rm=T),
             MIN_alt = min(b_alt, na.rm=T),
             MAX_alt = max(b_alt, na.rm=T))
```

